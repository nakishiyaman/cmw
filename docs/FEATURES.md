# cmw 機能詳細

このドキュメントでは、cmwの全機能を詳細に説明します。

## 目次

- [コア機能](#コア機能)
- [タスク管理](#タスク管理)
- [依存関係管理](#依存関係管理)
- [進捗管理](#進捗管理)
- [Claude Code統合](#claude-code統合)
- [品質保証](#品質保証)

---

## コア機能

### 1. 自動タスク生成

**RequirementsParser**により、`requirements.md`から自動的にタスクを生成します。

#### 機能詳細
- **Markdown解析**: セクション構造を解析し、階層的なタスクを生成
- **ファイルパス推論**: タスク内容から対象ファイルを自動推論（10種類のパターン対応）
  - バックエンド: `backend/*.py`
  - フロントエンド: `frontend/*.tsx`
  - API: `api/routes/*.py`
  - テスト: `tests/test_*.py`
  - ドキュメント: `docs/*.md`
  - 設定ファイル: `*.config.js`, `.env`等
- **依存関係推論**:
  - レイヤーベース（DB→API→テスト）
  - ファイルベース（同一ファイルへの操作順序）
- **優先度自動決定**: キーワードベースで HIGH/MEDIUM/LOW を自動判定

#### 使用例
```bash
cmw tasks generate
# → shared/docs/requirements.md を解析
# → shared/coordination/tasks.json に保存
```

---

### 2. ファイル競合検出

**ConflictDetector**により、タスク間のファイル競合を事前検出します。

#### 機能詳細
- **WRITE-WRITE競合検出**: 複数タスクが同一ファイルを編集する場合を検出
- **深刻度判定**:
  - **CRITICAL**: 5タスク以上が競合
  - **HIGH**: 3-4タスクが競合
  - **MEDIUM**: 2タスクが競合
  - **LOW**: 1タスクのみ
- **実行順序提案**: トポロジカルソートで最適な順序を提案
- **並列実行グループ**: 競合しないタスクをグループ化

#### 使用例
```bash
cmw tasks analyze

# 出力例:
# ⚠️  ファイル競合検出結果
#
# CRITICAL: auth.py (5タスク競合)
#   - TASK-001: ユーザー登録
#   - TASK-002: ログイン
#   - TASK-005: パスワードリセット
#   推奨実行順: TASK-001 → TASK-002 → TASK-005
```

---

### 3. リアルタイム進捗可視化

**Dashboard**により、美しいターミナルUIで進捗を可視化します。

#### 機能詳細
- **プロジェクト概要**:
  - 完了率、成功率
  - 残りタスク数、推定残り時間
- **ベロシティメトリクス**:
  - タスク完了速度（タスク/時間）
  - 平均所要時間
- **優先度別・担当者別進捗**:
  - Rich Tableによる見やすい表示
  - プログレスバー表示
- **最近のアクティビティ**:
  - タスク完了履歴のタイムライン表示

#### 使用例
```bash
# フルダッシュボード
cmw status

# コンパクト表示
cmw status --compact
```

---

## タスク管理

### 1. インテリジェント・タスク提案

**DependencyAnalyzer**により、次に実行すべきタスクを提案します。

#### 機能詳細
- **実行可能タスク抽出**: 依存関係がクリアされたタスクのみを表示
- **優先度順ソート**: HIGH → MEDIUM → LOW
- **クリティカルパス考慮**: ボトルネックとなるタスクを優先
- **影響範囲表示**: このタスクが完了すると何タスクがアンブロックされるか

#### 使用例
```bash
cmw task next

# 出力例:
# 🎯 実行可能なタスク (依存関係クリア済み)
#
# 1. TASK-002: 3.1 Userモデル
#    └─ 優先度: HIGH 🔴 CRITICAL
#    └─ 理由: クリティカルパス上, 14タスクをブロック中
#    └─ 影響範囲: 14タスクがブロック中
```

---

### 2. クリティカルパス分析

**DependencyAnalyzer**により、プロジェクト完了に最も影響するタスクを分析します。

#### 機能詳細
- **クリティカルパス計算**: 並列実行を考慮した最長パスを特定
- **完了予測**:
  - 楽観的予測: 並列実行フル活用
  - 悲観的予測: クリティカルパス基準
- **ボトルネック検出**: 多数のタスクをブロックしているタスクを警告
- **並列実行可能性**: 各段階で同時実行できるタスク数を表示

#### 使用例
```bash
cmw task critical

# 出力例:
# ⚡ クリティカルパス分析
#
# プロジェクト完了予測:
#   楽観的予測: 7.3日 (並行実行フル活用)
#   悲観的予測: 11.5日 (クリティカルパス基準)
#
# ⚠️  ボトルネック警告:
#   • TASK-002: 14タスクが依存
```

---

### 3. スマートタスク実行

**SmartPromptGenerator**により、詳細な実行プロンプトを自動生成します。

#### 機能詳細
- **タスク概要**: 重要度を強調
- **依存関係情報**:
  - 前提タスク（完了済み）
  - 待機中のタスク（このタスクが完了すると実行可能）
- **関連ファイル**: 対象ファイルと既存ファイルの一覧
- **実装ガイド**: ステップバイステップの手順
- **完了条件チェックリスト**: 受け入れ基準
- **テストコマンド**: 動作確認方法
- **次のステップ**: 完了後の推奨アクション

#### 使用例
```bash
cmw task exec TASK-002

# → 詳細プロンプトが表示される
# → ステータスが自動でin_progressに更新される
```

---

## 依存関係管理

### 1. 循環依存の自動検出と修正

**DependencyValidator**により、循環依存を検出し、自動修正を提案します。

#### 機能詳細
- **循環検出**: NetworkXのグラフアルゴリズムを使用
- **セマンティック分析**:
  - セクション番号ベースの判定
  - キーワードベースの判定（設定、DB、API、テスト等）
- **信頼度スコアリング**: 修正提案の確実性を100点満点で評価
- **自動修正**: 信頼度100%の場合は即座に適用

#### 使用例
```bash
# 検証のみ
cmw task validate

# 自動修正
cmw task validate --fix
```

---

### 2. 依存関係グラフの可視化

**GraphVisualizer**により、タスク間の依存関係を視覚化します。

#### 機能詳細
- **ASCII形式**: ターミナルで直接表示
- **Mermaid形式**: GitHub等で図として表示可能
- **統計情報**:
  - 総タスク数、依存関係数
  - ルートタスク、リーフタスク
  - 最大並列度
  - DAG判定（循環の有無）
- **クリティカルパス表示**: 最も重要なパスを強調

#### 使用例
```bash
# ASCII形式
cmw task graph

# Mermaid形式
cmw task graph --format mermaid

# 統計情報付き
cmw task graph --stats
```

---

## 進捗管理

### 1. Git連携による自動進捗同期

**GitIntegration**により、Gitコミットメッセージから進捗を自動同期します。

#### 機能詳細
- **タスクID検出**: コミットメッセージから`TASK-XXX`パターンを自動検出
- **自動完了マーク**: 検出したタスクを自動で完了にマーク
- **妥当性検証**: タスクの存在確認、重複完了チェック
- **期間指定**: `--since`オプションで検索開始時点を指定
- **ドライラン**: `--dry-run`で検出のみ実行（更新なし）

#### 使用例
```bash
# 過去1週間分のコミットから同期
cmw sync --from-git

# 過去1日分
cmw sync --from-git --since=1.day.ago

# 検出のみ（更新なし）
cmw sync --from-git --dry-run
```

---

### 2. タスク完了記録

**TaskCompletionCommand**により、タスク完了を詳細に記録します。

#### 機能詳細
- **完了マーク**: ステータスを`completed`に更新
- **生成ファイル記録**: `--artifacts`オプションで成果物を記録
- **完了メッセージ**: `--message`オプションでメモを追加
- **タイムスタンプ**: 完了日時を自動記録
- **進捗永続化**: `progress.json`に保存

#### 使用例
```bash
# シンプルな完了マーク
cmw task complete TASK-001

# 生成ファイルも記録
cmw task complete TASK-001 --artifacts '["backend/auth.py", "tests/test_auth.py"]'

# メッセージ付き
cmw task complete TASK-001 -m "実装完了、全テストパス"
```

---

## Claude Code統合

### 1. プロンプト自動生成

**PromptTemplate**により、Claude Code用のプロンプトを自動生成します。

#### 機能詳細
- **タスク実行プロンプト**: 単一タスク用
- **バッチ実行プロンプト**: 複数タスク用
- **レビュープロンプト**: コードレビュー用
- **依存タスク情報**: 前提タスクの成果物を参照
- **実装手順**: ステップバイステップのガイド

#### 使用例
```bash
cmw task prompt TASK-001

# → プロンプトが表示される
# → Claude Codeにコピー＆ペーストして使用
```

---

### 2. 応答自動解析

**ResponseParser**により、Claude Codeの応答を自動解析します。

#### 機能詳細
- **ファイルパス抽出**: 日本語・英語両対応
- **タスクID検出**: `TASK-XXX`パターンを検出
- **完了キーワード検出**: 「完了」「完成」「finished」等
- **エラー検出**: エラーメッセージの抽出
- **質問検出**: 不明点の抽出
- **完了コマンド提案**: 自動で`cmw task complete`コマンドを生成

---

## 品質保証

### 1. 100%型安全

**mypy**による静的型チェックで型エラーゼロを達成。

#### 詳細
- 22ファイル全てで型安全
- PEP 484準拠の型アノテーション
- CI/CDで自動型チェック

---

### 2. 88%テストカバレッジ（500テスト）

包括的なテストスイートで高品質を保証。

#### テストカテゴリ
- **コア機能テスト**: TaskProvider, StateManager, ParallelExecutor等
- **パフォーマンステスト**: 大規模グラフ、深い再帰、タイムアウト防止
- **統合テスト**: エンドツーエンドワークフロー、並行処理
- **エッジケーステスト**: 境界条件、Unicode対応、不正入力
- **セキュリティテスト**: パストラバーサル、コマンドインジェクション、DoS防止
- **信頼性テスト**: ファイル破損、エンコーディング、冪等性

---

### 3. パフォーマンス最適化

#### v0.6.2での修正
- **循環検出**: `nx.simple_cycles()` → `nx.find_cycle()` (指数時間 → O(E))
- **無限再帰防止**: 訪問ノード追跡により循環グラフでも安全
- **タイムアウト防止**: 複雑グラフ（25タスク、10循環）で3秒以内完了

---

### 4. セキュリティ対策

#### 実装済み対策
- **パストラバーサル防止**: `../../etc/passwd`等の攻撃を防ぐ
- **コマンドインジェクション対策**: シェルメタ文字のサニタイズ
- **ファイル権限検証**: 適切なパーミッション設定
- **DoS攻撃防止**: 大量依存、深いネストの制限
- **データ漏洩防止**: エラーメッセージでの機密情報露出防止

---

## まとめ

cmwは、Claude Codeと統合した包括的なタスク管理フレームワークです。自動タスク生成から進捗管理、品質保証まで、大規模プロジェクト開発に必要な全機能を提供します。

詳細な使用方法は[README.md](../README.md)、開発履歴は[ROADMAP.md](ROADMAP.md)を参照してください。
